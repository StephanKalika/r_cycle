---
title: "[Заметки по R](http://bdemeshev.github.io/r_cycle/): Написание пакета для R"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
lang: russian
---

> Каждая домохозяйка должна уметь создать пакет для R!

Для выпечки своего домашнего пакета R потребуется установить пакеты `devtools` --- для удобства инсталляции и `roxygen2` --- для документирования.

Для написания пакета под windows надо установить [`RTools`](https://cran.r-project.org/bin/windows/Rtools/), под macos/linux устанавливать `RTools` не требуется.

# Первичное создание пакета

* Создаём папку с названием нашего пакета, пусть будет пакет `honey`:)
* Внутри этой папки создаём подпапку `R`.
* Пишем несколько очень полезных функций и помещаем их в файл `honey.R` внутри папки `honey/R`. Если функций очень много, то их можно поместить в отдельные файлы.
* В папке `honey` создаём файл `DESCRIPTION` с описанием пакета. Примерно такой
```{r, eval=FALSE}
Package: honey
Type: Package
Title: R package to get honey
Version: 0.1
Date: 2014-07-25
Author: Winni-the-Pooh
Maintainer: Winni-the-Pooh <xxx.yyy@zzz.com>
Description: This package contains functions useful to distinguish good and bad bees.
License: MIT
```
Мелочи: 

* поле `Title` не должно содержать точку в конце
* поле `Description` должно состоять из одного или нескольких предложений и должно содержать точку в конце.

* Перед каждой функцией файла `honey.R` пишем документацию примерно такого вида:

```{r, eval=FALSE}
#' Evaluates the amount of good honey given the tree
#'
#' Evaluates the amount of good honey given the tree
#'
#' The amount of honey is estimated using the latest mcmc methods.
#'
#' @param tree the tree for which the amount of honey is estimated
#' @return numeric the estimated amount of good honey
#' @export
#' @examples
#' honey_evaluate(tree)
```

* В папке `honey` создаём файл `NEWS` с описанием истории создания пакета. Мы его будем обновлять при выходе новых версий. Для начала он может быть очень простым:
```{r, eval=FALSE}
# honey 0.1
* first public release of the package :)
```

* В начале файла `honey.R` пишем описание пакета в целом:


```{r, eval=FALSE}
#' honey: package to deal with good and bad bees
#'
#' Extremely important package for every Bear
#'
#' I've written this package a long time ago in a far-far galaxy.
#'
#' @name honey
#' @docType package
NULL
```

* Если пакет включает в себя наборы данных, то:

    * Создаём подпапку `data` в папке `honey`
    * Помещаем в неё все файлы с данными, пусть будет `pot.Rds`
    * В файл `honey.R` после описания пакета в целом помещаем описание данных
  
```{r, eval=FALSE}
#' Data on honey prices
#'
#' A dataset containing xxx The variables are as follows:
#'
#' \itemize{
#' \item pot the number of honey pot
#' \item price the price of the pot in rubbles
#' }
#'
#' @docType data
#' @keywords datasets
#' @name honey_price
#' @usage data(honey_price)
#' @format A data frame with xxx rows and yyy variables
NULL
```

# Типичный сценарий работы над пакетом

1. Создали репозиторий на `github` с двумя ветками, master и dev.

2. Загрузили пакеты для разработки, зашли в папку нашего пакета, включили режим разработки
```{r, eval=FALSE}
library("devtools")
setwd("honey")

dev_mode()
```

3. Что-то там изменили в функциях и в документации

4. Обновили документацию и провели базовую проверку пакета:
```{r, eval=FALSE}
check()
```

5. Закоммитили изменения в `dev` ветку репозитория.

6. Установили локально и подключили новую версию пакета для более подробного тестирования
```{r, eval=FALSE}
install("../honey")
library("honey")
```

7. Если не надоело, перешли к шагу 3.

8. Вышли из режима разработки
```{r, eval=FALSE}
dev_mode(FALSE)
```

9. Если получилось что-то путное, перенесли изменения из `dev` ветки в ветку `master`


# Загрузка пакета 

Любой другой человек сможет установить наш пакет командой
```{r, eval=FALSE}
devtools::install_github("username/honey")
```
здесь вместо `username` подразумевается гитхабовское имя владельца пакета.

Сырая `dev`-версия пакета ставится командой
```{r, eval=FALSE}
devtools::install_github("username/honey", ref = "dev")
```

И далее использовать после обычного
```{r, eval=FALSE}
library("honey")
```


Почиташки:

* Hadley Wickham, [R packages](http://r-pkgs.had.co.nz/)
* Simko, [From R code to R package](https://github.com/vsimko/course-rpackages)

