---
title: "[Заметки по R](http://bdemeshev.github.io/r_cycle/): Апельсины и простая регрессия"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
lang: russian
---

Подгрузим необходимые пакеты:

```{r, message=FALSE}
library("ggplot2") # кузявые графики
library("lmtest") # тесты для линейных моделей
library("dplyr") # манипуляции с данными
library("memisc") # сравнение моделей
library("pander") # таблички в markdown
library("broom") # стандартизация информации о модели и описательные статистики
```

## Простая работа с данными до оценки регрессий

В R есть куча встроенных наборов данных. Многие пакеты в себе помимо функций содержат также еще и примеры данных. Например, пакет `ggplot2` содержит в себе данные по стоимости бриллиантов `diamonds`.

Список всех наборов данных можно узнать с помощью команды `data()`.


Мы воспользуемся набором данных `Orange` про апельсиновые деревья.

Совсем кратко о наборе данных:
```{r}
glance(Orange)
```

Описательные статистики:
```{r}
tidy(Orange) 
```

Как выглядит начало таблички?
```{r}
head(Orange)
```

Структура набора данных. 
```{r}
str(Orange)
```

Команда `str` --- рабочая лошадка! Пакеты R пишет огромное количество людей, а она позволяет понять, из чего состоит тот или иной объект.


Более подробную информацию о наборе данных про Апельсины ищем у Чебурашки. Чебурашку можно позвать командой `help(Orange)`.

Графики
```{r}
qplot(x=age, y=circumference, data=Orange, color=Tree)
```


Оценим обыкновенную парную регрессию для того, чтобы понять, как диаметр дерева зависит от его возраста: 

```{r}
model <- lm(circumference~age, data=Orange) # оцениваем модель
report <- summary(model) # создаём отчет по модели
report # выводим отчет на экран
```

Из результатов оценивания можно вытащить

Ковариационную матрицу, $\hat{\sigma}^2(X'X)^{-1}$:
```{r}
vcov(model)
```

Любимый всеми $R^2$:
```{r}
report$r.squared
```

А также скорректированный $R^2_{adj}$:
```{r}
report$adj.r.squared
```

Коэффициенты:
```{r}
coef(model)
```

Доверительные интервалы для коэффициентов:
```{r}
confint(model, level=0.90)
```

Отдельно табличка с результатами тестов:
```{r}
coeftest(model)
```

Несколько моделей можно сравнить рядом в одной табличке:
```{r}
model_2 <- lm(data = Orange, circumference~age + I(age^2))
mtable(model, model_2)
```



Построим точечный прогноз диаметра дерева:
```{r}
new.data <- data_frame(age=c(100,200,300))
predict(model, new.data)
```

Прогноз с доверительным интервалом для среднего диаметра дерева:
```{r}
predict(model, new.data, interval="confidence")
```


И прогноз с предиктивным интервалом для конкретного наблюдения:
```{r}
predict(model, new.data, interval="prediction")
```

Есть удобный пакет `broom`. Основная его философия проста --- всю инфу о модели можно выдавать в data.frame. Пакет `broom` делит информацию на три уровня: 

* краткая о модели в целом 
* информация о коэффициентах
* то, что можно добавить к исходным данным после оценки модели. 

О модели в целом:
```{r}
glance(model)
```


Более подробную о коэффициентах:
```{r}
tidy(model)
```

Довесим исходные данные предсказанными значениями, остатками и прочим
```{r}
orange_plus <- augment(model, Orange)
glimpse(orange_plus)
```

К исходным данным добавлены:

* `.fitted` --- предсказанные $\hat y_i$
* `.resid` --- остатки $\hat\varepsilon_i$
* `.std.resid` --- стандартизованные остатки, $s_i = \frac{\varepsilon_i}{\sqrt{\hat{\sigma}^2(1-h_{ii})}}$
...
дописать





Что еще можно вытащить из оцененной модели, можно узнать несколькими способами. Например, стоит почитать `help(summary.lm)`. Можно еще набрать в консоли `model$` и пару раз кликнуть `<Tab>`. Еще имеет смысл попробовать нажать `<Tab>` после `summ$`. Можно набрать `str(model)`. Да еще гугл есть.

А вообще бывает полезно изобрести велосипед. Пусть где-то в R уже есть функция, считающая доверительный интервал для прогноза. Если вместо этого написать эту функцию своими руками, то можно получить плюс один к экспириенсу и перейти на следующий уровень.


Почиташки:

* Виньетка [к пакету `broom`](https://github.com/dgrtwo/broom)