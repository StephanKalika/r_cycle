---
title: "[Заметки по R](http://bdemeshev.github.io/r_cycle/): Метод главных компонент"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
lang: russian
---

Метод главных компонент позволяет уменьшить количество ипользуемых переменных с минимальными потерями информации.


### Частный случай: от двух переменных к одной

Что делает регрессия $y$ на $x$? Строит прямую так, чтобы сумма квадратов вертикальных отклонений точек от прямой была бы минимальна.

Что делает регрессия $x$ на $y$? Строит прямую так, чтобы сумма квадратов горизонтальных отклонений точек от прямой была бы минимальна.

Что делает выделение главной компоненты векторов $x$ и $y$? Строит прямую так, чтобы сумма квадратов отклонений точек от прямой по перпендикуляру была бы минимальна.

### Еще одна трактовка метода главных компонент

Мы хотим вместо $k$ переменных оставить $p<k$. Другими словами, хотим заменить матрицу $X_{n\times k}$ на матрицу $\hat{X}_{n\times k}$ ранга $p$ так, чтобы минимизировать сумму квадратов ошибок:
\[
\min \sum_{j=1}^k \sum_{i=1}^n (x_{ij}-\hat{x}_{ij})^2
\]


Загружаем нужные пакеты:
```{r, message=FALSE}
library("knitr")
#opts_chunk$set(cache=TRUE) # кэшируем фрагменты кода

library("ggplot2") # для построения графиков
library("HSAUR") # здесь подходящий набор данных
library("FactoMineR")

opts_chunk$set(fig.align = 'center') 
options(width = 110)
theme_set(theme_bw())
```

Загружаем интересующий нас набор данных по многоборью:
```{r, f}
data(heptathlon)
head(heptathlon)
```

Корреляции исходных переменных:
```{r}
print(cor(heptathlon), digits = 2)
```

Применяем метод главных компонент к исходным, нестандартизированным переменным. Восьмой столбец (*score*) нам не нужен, т.к. это не результат отдельного соревнования, а сумма баллов по многоборью. 
```{r}
hept.pca <- prcomp(heptathlon[, -8])
```

Теперь можно раздобыть сами главные компоненты:
```{r}
head(hept.pca$x)
```

Веса исходных переменных в главных компонентах:
```{r}
head(hept.pca$rotation)
```

Смотрим, как первая компонента связана с итоговым результатом спортсмена:
```{r}
pc1 <- hept.pca$x[, 1]

qplot(x = pc1, y = heptathlon$score) + 
  labs(x = "Первая главная компонента",
       y = "Сумма баллов по многоборью",
       title = "Связь первой компоненты с итоговым результатом")

cor(pc1, heptathlon$score) 
```

Посмотрим, какую долю дисперсии объясняют главные компоненты: 
```{r}
summary(hept.pca)
```

Для построения графика сначала получим вектор долей дисперсии, объясняемых переменными:
```{r}
exp_percent <- summary(hept.pca)$importance[2, ]
n <- names(exp_percent)
qplot(y = exp_percent, x = names(exp_percent)) + 
  geom_bar(stat = 'identity') +
  labs(x = "Главные компоненты",
       y = "Доли диспесии",
       title = "Доли дисперсии, объясняемые главными компонентами \n (без предварительной стандартизации)")
```

Внимательно посмотрев на сами данные, замечаем, что они в существенно разных единицах измерения...
```{r}
summary(heptathlon)
```

Следовательно, первая главная компонента ловила прежде всего тот факт, что результаты бега на 800 метров имеют наибольший разброс и ничего больше. Поэтому применим метод главных компонент с предварительной стандартизацией:
```{r}
hept.pca2 <- prcomp(heptathlon[, -8], scale = TRUE)
```

График первых двух компонент с вкладом каждой переменной:
```{r, fig.height=6, fig.width=8}
biplot(hept.pca2, 
       xlim = c(-0.8, 0.8), ylim = c(-0.6, 0.6))
```

На этом графике видно, например, что:

* Спортсменка Launa из Папуа-Новой Гвинеи не такая как все!
* С ростом результата прыжка в длину, `longjump`, первая главная компонента падает, а вторая --- практически не изменяется.
* Переменные `longjump` и `hurdles` предположительно отрицательно коррелированы, т.к. с ростом первой главной компоненты меняются в разные стороны.

Метод главных компонент можно реализовать не только в рамках стандартной комплектации R, но и с помощью, например, пакета `FactoMineR` для работы с многомерными данными. При создании пакета авторы частично руководствовались целью сделать процесс анализа более графически наглядным и более дружелюбным к пользователю. Например, сама функция `PCA()` для реализации метода сразу строит два информативных графика:
```{r}
hept.pca3 <- PCA(heptathlon[, -8])
```



Источники:

* [Статья](http://factominer.free.fr/docs/article_FactoMineR.pdf) про пакет `FactoMineR`
