---
title: "[Заметки по R](http://bdemeshev.github.io/r_cycle/): Работа с панельными данными"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
lang: russian
---

Загружаем нужные пакеты:
```{r, message=FALSE}
library("knitr")
# opts_chunk$set(cache=TRUE)

library("ggplot2")
library("plm")
# install.packages("plm") # может быть нужно установить пакеты...
```

Берём встроенный в пакет `plm` набор данных `Grunfeld`
```{r}
data(Grunfeld)
head(Grunfeld)
```

Указываем R, какая переменная отвечает за $i$, какая --- за $t$.
```{r}
h <- pdata.frame(Grunfeld,
                 index=c("firm","year"),
                 row.names=TRUE)
```

Посмотрим на кусок таблички:
```{r}
Grunfeld[12:16,3:5]
h[12:16,3:5]
```

Добавим лагированные инвестиции
```{r}
h$linv <- lag(h$inv)
head(h)
```


Оценим три модели:
```{r}
m.pooled <- plm(inv~capital+value,data=h,model="pooling")
m.re <- plm(inv~capital+value,data=h,model="random")
m.fe <- plm(inv~capital+value,data=h,model="within")
```

Посмотрим отчёт по модели со случайным эффектами:
```{r}
summary(m.re)
```

На самом деле модель сквозной регрессии и модель с фиксированными эффектами оцениваются обычным МНК. Эти результаты можно воспроизвести без пакета `plm` своими руками:
```{r}
m.pooled.lm <- lm(inv~capital+value,data=h)
m.fe.lm <- lm(inv~capital+value+factor(firm),data=h)
```

Сравним коэффициенты:
```{r}
coefficients(m.pooled)
coefficients(m.pooled.lm)
```

Аналогично совпадут и коэффициенты в моделях с фиксированными эффектами.


Проведём три теста на сравнение моделей. 
* Фиксированные эффекты против сквозной регрессии. Обычный F-тест.
```{r}
pFtest(m.fe,m.pooled)
```
* Фиксированные эффекты против случайных эффектов. Тест Хаусмана.
```{r}
phtest(m.fe,m.re)
```
* Случайные эффекты против сквозной регрессии. Тест Бройша-Пагана, является одним из тестов множителей Лагранжа.
```{r}
plmtest(m.re,type="bp")
```

Типичные проблемы при работе с панельными данными.

* Оценки по методу FE невозможно получить, если есть регрессор, являющийся константой для каждой отдельной фирмы.

Например,

...

* Оценки по методу RE невозможно получить, если число переменных больше количества фирм.


...

* При оценке по методу RE может получаться отрицательная оценка дисперсиии
```{r, eval=FALSE}
m.re <- plm(inv~capital+value+linv,data=h,model="random")
```
```{r, echo=FALSE}
print(try(m.re <- plm(inv~capital+value+linv,data=h,model="random"))[1])
```


Скорее всего это говорит о том, что имеющиеся данные плохо описываются моделью RE. Вероятнее всего в данных другая структура корреляции ошибок. Например, там присутствует автокорреляция первого порядка...











