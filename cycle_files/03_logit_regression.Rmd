---
title: "[Заметки по R](http://bdemeshev.github.io/r_cycle/): Логит и пробит модели"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
lang: russian
---

Загружаем библиотеки
```{r, message=FALSE}
library("mfx") # подсчет предельных эффектов
library("ggplot2") # графики
library("lmtest") # линейные регрессии 
library("foreign") # чтение файлов в некоторых форматах
library("dplyr") # манипуляции с таблицами
library("broom") # описание модели в виде таблички
```

Загружаем [данные](https://github.com/bdemeshev/em301/raw/master/datasets/mesto_jenshini.dta) в R:
```{r}
role <- read.dta("../datasets/mesto_jenshini.dta")
```

Это данные американского социологического опроса National Longitudinal Survey of Youth. Основная переменная, `agree`, показывает согласна ли опрашиваемая женщина с утверждением "Место женщины у плиты!" Мы оценим logit и probit модели для переменной `agree`.

![Tsvetkov, Mesto jenshini](03_plita.gif)

Андрей Цветков, ["Место женщины"](http://ccra.ru/Plk)

## До оценки моделей

Проверяем, что всё корректно загрузилось --- `.dta` это не родной для R формат. 
```{r}
glimpse(role)
```

Смотрим на описательные статистики:
```{r}
tidy(role)[c("column", "n", "mean", "median", "min", "max", "sd")]
```

Несколько графиков до построения моделей:
```{r}
ggplot(role) + geom_bar(aes(factor(agree))) + scale_x_discrete(breaks = c("1", "0"), 
  labels = c("Да", "Нет")) + labs(x = "Согласны ли с утверждением?", y = "Количество женщин", 
  title = "Результаты опроса")
```

## Собственно оценка моделей

Логит, пробит и мнк. Предпосылки применения мнк нарушены, но мы его всё равно применим и посмотрим, что выйдет.
```{r}
m_logit <- glm(agree ~ age + adjinc + nsibs,
          data = role,
          family = binomial(link = "logit"))
m_probit <- glm(agree ~ age + adjinc + nsibs,
          data = role,
          family = binomial(link = "probit"))
m_ols <- glm(agree ~ age + adjinc + nsibs,
          data = role)
```

Кратко о логит-модели:
```{r}
glance(m_logit)
```

Оценки коэффициентов:
```{r}
tidy(m_logit)
```


Ковариационную матрицу оценок коэффициентов также раздобыть легко
```{r}
vcov(m_logit)
```


Коэффициенты в логит и пробит моделях плохо интерпретируемы, т.к. скрытая переменная, в данной задаче  склонность к ответу "да", измеряется в непонятных единицах. В дополнение к коэффициентам рассчитывают предельные эффекты. Предельные эффекты отвечают на вопрос, как изменится примерно вероятность `y = 1` с ростом регрессора на единицу. Обычно предельные эффекты считаются для среднего значения каждого регрессора:
```{r}
logitmfx(agree ~ age + adjinc + nsibs, data = role)
```

### Сообщения об ошибках

* fitted probabilities numerically 0 or 1 occurred. Означает, что при итерациях при поиске максимума правдоподобия для какого-то наблюдения оцененные вероятности были настолько близки к нулю или единице, что у компьютера не хватает ячейки памяти, чтобы их отличить от нуля или единицы. Само по себе это нестрашно.
* algorithm did not converge. Можно попробовать увеличить количество итераций, иногда это помогает. В сочетании с предыдущим сообщением может быть показателем того, что 0 и 1 идеально разделяются какой-то переменной и возможно [«идеальное» прогнозирование](http://stats.stackexchange.com/questions/45803).


## Прогнозы

Создаем набор данных, для которого мы будем строить прогнозы:
```{r}
new <- data_frame(age = c(20, 24),
                  adjinc = c(16000, 4000),
                  nsibs = c(2, 5))
new
```

В логит и пробит-моделях можно прогнозировать значение скрытой переменной (склонности ответить "да") или вероятность $y_i=1$ (вероятность ответить "да"). Прогноз скрытой переменной:
```{r}
augment(m_logit, newdata = new)
```

Немножко другой командой получаются прогнозы вероятности $y_i=1$:
```{r}
augment(m_logit, newdata = new, type.predict = "response")
```

Заметим приятный факт. Для средних значений регрессоров обычный МНК, который формально нельзя применять из-за нарушения предпосылок теоремы Гаусса-Маркова, даёт вполне корректные прогнозы:
```{r}
augment(m_ols, newdata = new)
```

Проблемы МНК видны на краевых значениях регрессоров. Тут запросто могут быть отрицательные вероятности :)

```{r}
augment(m_ols, newdata = data_frame(age = 100, adjinc = 10^5, nsibs = 0))
```



Поскольку в методе максимального правдоподобия оценка любого параметра является асимпотически нормальной, то доверительный интервал для любого параметра $a$ строится по принципу $[\hat{a}-z_{cr}se(\hat{a});\hat{a}+z_{cr}se(\hat{a})]$. 


Поскольку чаще всего нужен доверительный интервал именно для вероятностей, мы построим только его. Если нужен доверительный интервал для ожидаемой склонности ответить да, то достаточно просто убрать опцию `prediction.type`:

```{r}
new2 <- augment(m_logit, newdata = new, type.predict = "response")
z_cr <- qnorm(0.975)
new2 <- mutate(new2, 
               ci_left = .fitted - z_cr * .se.fit,
               ci_right = .fitted + z_cr * .se.fit)
new2
```








Binary prediction. Best binary prediction?


## Выбор между вложенными моделями

Likelihood ratio, LR-test, Тест отношения правдоподобия
```{r}
m2_logit <- glm(agree ~ age + age2 + adjinc + nsibs,
          data = role,
          family = binomial(link = "logit"))
lrtest(m_logit, m2_logit)
```

Lagrange multiplier test, LM-test, тест множителей Лагранжа (? by hands)

Wald-test, Тест Вальда
```{r}
waldtest(m_logit, m2_logit, test = "Chisq")
```






## Кривые ROC




ROC ручками...





ROC с помощью пакета ROCR



